# TCP/IP数据链路层的交互过程（待整理）
网络层等到数据链层用 mac 地址作为通信目标，数据包到达网络层准备往数据链层发送的时候，首先会去自己的 arp 缓存表(存着 ip-mac 对应关系)去查找该目标 ip 的 mac 地址，如果查到了，就将目标 ip 的 mac 地址封装到链路层数据包的包头。如果缓存中没有找到，会发起一个广播：who is ip XXX tell ip XXX,所有收到的广播的机器看这个 ip 是不是自己的，如果是自己的，则以单拨的形式将自己的 mac 地址回复给请求的机器。
> 需要一种方法来完成IP地址到MAC地址的映射，这就是地址解析协议(Address Resolution Protocol）。
> 每台主机都设有一个ARP高速缓存，用来存放本局域网上各主机和路由器的IP地址到MAC 地址的映射表，称ARP表。使用ARP来动态维护此ARP表。
> ARP 工作在网络层，其工作原理如下：主机A 欲向本局域网上的某台主机B 发送IP 数据报时，先在其ARP 高速缓存中查看有无主机B 的IP 地址。如有，就可查出其对应的硬件地址，再将此硬件地址写入MAC 帧，然后通过局域网将该MAC 帧发往此硬件地址。如果没有，那么就通过使用目的MAC 地址为FF-FF-FF-FF-FF-FF 的帧来封装并广播ARP 请求分组，使同一个局域网里的所有主机收到ARP 请求。主机B 收到该ARP 请求后，向主机A 发出响应ARP 分组，分组中包含主机B 的IP与MAC 地址的映射关系，主机A 在收到后将此映射写入ARP 缓存，然后按查询到的硬件地址发送MAC 帧。ARP 由于“看到了"IP 地址，所以它工作在网络层，而NAT路由器由于“看到了“端口，所以它工作在传输层。

