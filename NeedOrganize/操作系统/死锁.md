# ==死锁的定义==

所谓死锁，是指多个进程因竞争资源而造成的一种僵局（互相等待），若无外力作用，这些进程都将无法向前推进。

【死锁实例】：某计算机系统中只有一台打印机和一台输入设备，进程P1正占用输入设备，同时又提出使用打印机的请求，但此时打印机正被进程P2所占用，而P2在未释放打印机之前，又提出请求使用正被P1占用的输入设备。这样，两个进程相互无休止地等待下去，均无法继续执行，此-时两个进程陷入死锁状态。

# ==死锁产生的原因==

* 系统资源的竞争

  只有对不可剥夺资源的竞争才可能产生死锁。

* 进程推进顺序非法

  例如，并发进程P1, P2分别保持了资源R1,R2, 而进程P1 申请资源R2、进程P2申请资源R1 时，两者都会因为所需资源被占用而阻塞。

# ==死锁产生的必要条件==

1. 互斥条件

   进程要求对所分配的资源（如打印机）进行排他性控制，即在一段时间内某资源仅为一个进程所占有。此时若有其他进程请求该资源，则请求进程只能等待。

2. 不剥夺条件

   进程所获得的资源在未使用完之前，不能被其他进程强行夺走，即只能由获得该资源的进程自己来释放（只能是主动释放）。

3. 请求并保持条件

   进程已经保持了至少一个资源，但又提出了新的资源请求，而该资源已被其他进程占有，此时请求进程被阻塞，但对自己已获得的资源保持不放。

4. 循环等待条件

   存在一种进程资源的循环等待链，链中每个进程已获得的资源同时被链中下一个进程所请求。即存在一个处于等待态的进程集合{P1, P2, ..., Pn}，其中Pi等待的资源被Pi+1(i=0, 1, ..., n-1)占有，Pn等待的资源被P0占有。

   ![image-20201126183952061](D:\notes\面试准备\操作系统\死锁.assets\image-20201126183952061.png)

# ==死锁的处理策略==

1. 死锁预防

   设置某些限制条件，**破坏产生死锁的4个必要条件**中的一个或几个，以防止发生死锁。

   * 破坏互斥条件

   * 破坏不剥夺条件

     当一个已保持了某些不可剥夺资源的进程请求新的资源而得不到满足时，它必须释放已经保持的所有资源，待以后需要时再重新申请。

   * 破坏请求并保持条件

     采用预先静态分配方法，即进程在运行前一次申请完它所需要的全部资源，在它的资源未满足前，不把它投入运行。一旦投入运行，这些资源就一直归它所有，不再提出其他资源请求，这样就可以保证系统不会发生死锁。

   * 破坏循环等待条件

     为了破坏循环等待条件，可采用顺序资源分配法。首先给系统中的资源编号，规定每个进程必须按编号递增的顺序请求资源，同类资源一次申请完。也就是说，只要进程提出申请分配资源Ri, 则该进程在以后的资源中请中就只能申请编号大于Ri的资源。

2. 避免死锁

   在**资源的动态分配过程**中，用某种方法防止系统进入不安全状态，从而避免死锁。

   避免死锁的方法中，允许进程动态地申请资源，但系统在进行资源分配之前，应先计算此次分配的安全性。若此次分配不会导致系统进入不安全状态，则允许分配；否则让进程等待。

   并非所有的不安全状态都是死锁状态，但当系统进入不安全状态后，便可能进入死锁状态；反之，只要系统处于安全状态，系统便可避免进入死锁状态。

   **银行家算法**

   主要思想是避免系统进入不安全状态，在每次进行资源分配时，它首先检查系统是否有足够的资源满足要求，如果有，则先试行分配，并对分配后的新状态进行安全性检查。如果新状态安全，则正式分配上述资源，否则拒绝分配上述资源。这样就保证系统始终处于安全状态，从而避免死锁现象的发生。

3. 死锁的检测及解除

   无须采取任何限制性措施，允许进程在运行过程中发生死锁。通过系统的检测机构及时地**检测**出死锁的发生，然后采取某种措施**解除**死锁。

   * 死锁检测

     S为死锁的条件是当且仅当S状态的资源分配图是不可完全简化的，该条件为死锁定理。

   * 死锁解除

     * 资源剥夺法

       挂起某些死锁进程，并抢占它的资源，将这些资源分配给其他的死锁进程。但应防止被挂起的进程长时间得不到资源而处于资源匮乏的状态。

     * 撤销进程法

       强制撤销部分甚至全部死锁进程并剥夺这些进程的资源。撤销的原则可以按进程优先级和撤销进程代价的高低进行。

     * 进程回退法

       让一（或多）个进程回退到足以回避死锁的地步，进程回退时自愿释放资源而非被剥夺。要求系统保持进程的历史信息，设置还原点。

