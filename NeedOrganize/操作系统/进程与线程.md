# 程序

程序是含有指令和数据的文件，被存储在磁盘或其他的数据存储设备中，也就是说程序是静态的代码。

# ==进程==

进程是对运行时程序的封装，是系统进行**资源调度和分配**的的基本单位，实现了**操作系统**的并发。

在多道程序环境下，允许多个程序并发执行，此时它们将失去封闭性，并具有间断性及不可再现性的特征。为此引入了进程(Process) 的概念，以便更好地描述和控制程序的并发执行，实现操作系统的并发性和共享性（最基本的两个特性）。

为了使参与并发执行的程序（含数据）能独立地运行，必须为之配置一个专门的数据结构，称为进程控制块(Process Control Block, PCB) 。系统利用PCB来描述进程的基本情况和运行状态，进而控制和管理进程。 

相应地，由程序段、相关数据段和PCB三部分构成了进程映像（进程实体）。所谓创建进程，实质上是创建进程映像中的PCB; 而撤销进程，实质上是撤销进程的PCB 。值得注意的是，进程映像是静态的， 进程则是动态的。

引入进程实体的概念后，我们可以把传统操作系统中的进程定义为： “进程是进程实体的运行过程，是系统进行资源（处理机、存储器和其他设备服务于某个进程的时间）分配和调度的一个独立单位。”

# ==线程==
线程是进程的子任务，是**CPU调度和分派**的基本单位，用于保证程序的实时性，实现**进程内部**的并发；线程是操作系统可识别的最小执行和调度单位。每个线程都独自占用一个虚拟处理器：独自的寄存器组，指令计数器和处理器状态。每个线程完成不同的任务，但是共享同一地址空间（也就是同样的动态内存，映射文件，目标代码等等），打开的文件队列和其他内核资源。
# ==区别==
1. 一个线程只能属于一个进程，而一个进程可以有多个线程，但至少有一个线程。线程依赖于进程而存在。
2. 进程在执行过程中拥有独立的内存单元，而多个线程共享进程的内存。（资源分配给进程，同一进程的所有线程共享该进程的所有资源。同一进程中的多个线程共享代码段（代码和常量），数据段（全局变量和静态变量），扩展段（堆存储）。但是每个线程拥有自己的**栈段**，栈段又叫运行时段，用来存放所有局部变量和临时变量。）
3. 进程是资源分配的最小单位，线程是CPU调度的最小单位。
4. 系统开销：由于在创建或撤消进程时，系统都要为之分配或回收资源，如内存空间、I/O设备等。因此，操作系统所付出的开销将显著地大于在创建或撤消线程时的开销。类似地，在进行进程切换时，涉及到整个当前进程CPU环境的保存以及新被调度运行的进程的CPU环境的设置。而线程切换只须保存和设置少量寄存器的内容，并不涉及存储器管理方面的操作。可见，进程切换的开销也远大于线程切换的开销。
5. 通信：由于同一进程中的多个线程具有相同的地址空间，致使它们之间的同步和通信的实现，也变得比较容易。进程间通信IPC，线程间可以直接读写进程数据段（如全局变量）来进行通信——需要进程同步和互斥手段的辅助，以保证数据的一致性。在有的系统中，线程的切换、同步和通信都无须操作系统内核的干预。
6. 进程编程调试简单可靠性高，但是创建销毁开销大；线程正相反，开销小，切换速度快，但是编程调试相对复杂。
7. 进程间不会相互影响 ；线程一个线程挂掉将导致整个进程挂掉。
8. 拥有资源：不论是传统操作系统还是设有线程的操作系统，进程都是拥有资源的基本单位，而线程不拥有系统资源（也有一点儿必不可少的资源），但线程可以访问其隶属进程的系统资源。要知道，若线程也是拥有资源的单位，则切换线程就需要较大的时空开销，线程这个概念的提出就没有意义。

# ==进程间通信的方式==
进程间通信主要包括管道、系统IPC（包括消息队列、信号量、信号、共享内存等）、以及套接字socket。
1. 管道：
管道主要包括无名管道和命名管道。管道可用于具有亲缘关系的父子进程间的通信，命名管道除了具有管道所具有的功能外，它还允许无亲缘关系进程间的通信。
* 普通管道PIPE：
1） 它是半双工的（即数据只能在一个方向上流动），具有固定的读端和写端。
2） 它只能用于具有亲缘关系的进程之间的通信（也是父子进程或者兄弟进程之间）
3） 它可以看成是一种特殊的文件，对于它的读写也可以使用普通的read、write等函数。但它不是普通的文件，并不属于其他任何文件系统，并且只存在于内存中。
* 命名管道FIFO：
1） FIFO可以在无关的进程之间交换数据。
2） FIFO有路径名与之相关联，它以一种特殊设备文件形式存在于文件系统中。
2. 系统IPC
* 消息队列：
消息队列，是消息的链表，存放在内核中。一个消息队列由一个标识符（即队列ID）来标记。（消息队列克服了信号传递信息少，管道只能承载无格式字节流以及缓冲区大小受限等特点）具有写权限的进程可以按照一定的规则向消息队列中添加新信息；对消息队列有读权限的进程则可以从消息队列中读取信息。
特点：
1） 消息队列是面向记录的，其中的消息具有特定的格式以及特定的优先级。
2）消息队列独立于发送与接收数据进程。进程终止时，消息队列及其内容不会被删除。
3）消息队列可以实现消息的随机查询，消息不一定要以先进先出的次序读取，也可以按消息的类型读取。
* 信号量semaphore：
信号量与已经介绍过的IPC结构不同，它是一个计数器，可以用来控制多个进程对共享资源的访问。信号量用于实现进程间的互斥和同步，而不是用于存储进程间通信数据。
特点：
1） 信号量用于进程间同步，若要在进程间传递数据需要结合共享内存。
2） 信号量基于操作系统的PV操作，程序对信号量的操作都是原子操作。
3） 每次对信号量的PV操作不仅限于对信号量值加1或减1，而且可以加减任意正整数。
4） 支持信号量组。
* 信号signal：
信号是一种比较复杂的通信方式，用于通知接收进程某个事件已经发生。
* 共享内存share memory：
它使得多个进程可以访问同一块内存空间，不同进程可以及时看到对方进程中对共享内存中数据的更新。这种方式需要依靠某种同步操作，如互斥锁和信号量等。
特点：
1） 共享内存是最快的一种IPC，因为进程是直接对内存进行存取。
2） 因为多个进程可以同时操作，所以需要同步。
3） 信号量+共享内存通常结合在一起使用，信号量用来同步对共享内存的访问。
3. 套接字socket：
socket也是一种进程间通信机制，与其他通信机制不同的是，它可用于不同主机之间的进程通信。
# ==线程间通信的方式==
1. 锁机制：包括互斥锁/量（mutex）、读写锁（reader-writer lock）、自旋锁（spin lock）、条件变量（condition）
   - 互斥锁/量（mutex）：提供了以排他方式防止数据结构被并发修改的方法。
   - 读写锁（reader-writer lock）：允许多个线程同时读共享数据，而对写操作是互斥的。
   - 自旋锁（spin lock）与互斥锁类似，都是为了保护共享资源。互斥锁是当资源被占用，申请者进入睡眠状态；而自旋锁则循环检测保持者是否已经释放锁。
   - 条件变量（condition）：可以以原子的方式阻塞进程，直到某个特定条件为真为止。对条件的测试是在互斥锁的保护下进行的。条件变量始终与互斥锁一起使用。
2. 信号量Semaphore：为控制具有有限数量的用户资源而设计的，它允许多个进程在同一时刻去访问同一个资源，但一般需要限制同一时刻访问此资源的最大线程数目。
3. 事件（信号）wait/notify：通过通知操作的方式来保持多线程同步，还可以方便地实现多进程优先级的比较操作。

# 进程/线程之间私有和共享的资源

## 进程之间私有和共享的资源

- 私有：地址空间、堆、全局变量、栈、寄存器
- 共享：代码段，公共数据，进程目录，进程 ID

## 线程之间私有和共享的资源

- 私有：线程栈，寄存器，程序计数器
- 共享：堆，地址空间，全局变量，静态变量

# ==多进程和多线程间的对比、优劣与选择==

## 对比

| 对比维度       | 多进程                                                       | 多线程                                                       | 总结     |
| -------------- | ------------------------------------------------------------ | ------------------------------------------------------------ | -------- |
| 数据共享、同步 | 数据共享复杂，需要用 IPC；数据是分开的，同步简单             | 因为共享进程数据，数据共享简单，但也是因为这个原因导致同步复杂 | 各有优势 |
| 内存、CPU      | 占用内存多，切换复杂，CPU 利用率低                           | 占用内存少，切换简单，CPU 利用率高                           | 线程占优 |
| 创建销毁、切换 | 创建销毁、切换复杂，速度慢                                   | 创建销毁、切换简单，速度很快                                 | 线程占优 |
| 编程、调试     | 编程简单，调试简单                                           | 编程复杂，调试复杂                                           | 进程占优 |
| 可靠性         | 进程间不会互相影响                                           | 一个线程挂掉将导致整个进程挂掉                               | 进程占优 |
| 分布式         | 适应于多核、多机分布式；如果一台机器不够，扩展到多台机器比较简单 | 适应于多核分布式                                             | 进程占优 |

## 优劣

| 优劣 | 多进程                                   | 多线程                                   |
| ---- | ---------------------------------------- | ---------------------------------------- |
| 优点 | 编程、调试简单，可靠性较高               | 创建、销毁、切换速度快，内存、资源占用小 |
| 缺点 | 创建、销毁、切换速度慢，内存、资源占用大 | 编程、调试复杂，可靠性较差               |

## 选择

- 需要频繁创建销毁的优先用线程
- 需要进行大量计算的优先使用线程
- 强相关的处理用线程，弱相关的处理用进程
- 可能要扩展到多机分布的用进程，多核分布的用线程
- 都满足需求的情况下，用你最熟悉、最拿手的方式

